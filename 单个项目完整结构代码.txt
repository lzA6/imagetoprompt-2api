é¡¹ç›® 'imagetoprompt-2api' çš„ç»“æ„æ ‘:
ğŸ“‚ imagetoprompt-2api/
    ğŸ“„ .env
    ğŸ“„ .env.example
    ğŸ“„ Dockerfile
    ğŸ“„ docker-compose.yml
    ğŸ“„ main.py
    ğŸ“„ nginx.conf
    ğŸ“„ requirements.txt
    ğŸ“‚ app/
        ğŸ“‚ core/
            ğŸ“„ __init__.py
            ğŸ“„ config.py
        ğŸ“‚ providers/
            ğŸ“„ __init__.py
            ğŸ“„ base_provider.py
            ğŸ“„ imagetoprompt_provider.py
        ğŸ“‚ utils/
            ğŸ“„ sse_utils.py
    ğŸ“‚ static/
        ğŸ“„ index.html
        ğŸ“„ script.js
        ğŸ“„ style.css
================================================================================

--- æ–‡ä»¶è·¯å¾„: .env ---

# [è‡ªåŠ¨å¡«å……] imagetoprompt-2api ç”Ÿäº§ç¯å¢ƒé…ç½®
# è¯¥æ–‡ä»¶ç”± Project Chimera è‡ªåŠ¨ç”Ÿæˆã€‚

# --- å®‰å…¨é…ç½® ---
# ç”¨äºä¿æŠ¤æ‚¨çš„ API æœåŠ¡çš„è®¿é—®å¯†é’¥ï¼Œè¯·æŒ‰éœ€ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¤æ‚å¯†é’¥ã€‚
API_MASTER_KEY=1

# --- éƒ¨ç½²é…ç½® ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088


--- æ–‡ä»¶è·¯å¾„: .env.example ---

# ====================================================================
# imagetoprompt-2api é…ç½®æ–‡ä»¶æ¨¡æ¿
# ====================================================================
#
# è¯·å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º ".env" å¹¶æŒ‰éœ€ä¿®æ”¹ã€‚
#

# --- æ ¸å¿ƒå®‰å…¨é…ç½® (å¿…é¡»è®¾ç½®) ---
# ç”¨äºä¿æŠ¤æ‚¨ API æœåŠ¡çš„è®¿é—®å¯†é’¥ã€‚
API_MASTER_KEY=sk-imagetoprompt-2api-default-key

# --- éƒ¨ç½²é…ç½® (å¯é€‰) ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088


--- æ–‡ä»¶è·¯å¾„: Dockerfile ---

# ====================================================================
# Dockerfile for imagetoprompt-2api (v1.0)
# ====================================================================

FROM python:3.10-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

# å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°é root ç”¨æˆ·
RUN useradd --create-home appuser && \
    chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£å¹¶å¯åŠ¨
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]


--- æ–‡ä»¶è·¯å¾„: docker-compose.yml ---

services:
  nginx:
    image: nginx:latest
    container_name: imagetoprompt-2api-nginx
    restart: always
    ports:
      - "${NGINX_PORT:-8088}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
    networks:
      - imagetoprompt-net

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: imagetoprompt-2api-app
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - imagetoprompt-net

networks:
  imagetoprompt-net:
    driver: bridge


--- æ–‡ä»¶è·¯å¾„: main.py ---

import sys
import re
from contextlib import asynccontextmanager
from typing import Optional

from fastapi import FastAPI, Request, HTTPException, Depends, Header, File, UploadFile, Form
from fastapi.responses import JSONResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
from loguru import logger

from app.core.config import settings
from app.providers.imagetoprompt_provider import ImageToPromptProvider

# --- é…ç½® Loguru ---
logger.remove()
logger.add(
    sys.stdout,
    level="INFO",
    format="<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | "
           "<level>{level: <8}</level> | "
           "<cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
    colorize=True
)

# --- å…¨å±€ Provider å®ä¾‹ ---
provider = ImageToPromptProvider()

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info(f"åº”ç”¨å¯åŠ¨ä¸­... {settings.APP_NAME} v{settings.APP_VERSION}")
    await provider.initialize()
    logger.info(f"æœåŠ¡å°†åœ¨ http://localhost:{settings.NGINX_PORT} ä¸Šå¯ç”¨")
    logger.info(f"Web UI æµ‹è¯•ç•Œé¢å·²å¯ç”¨ï¼Œè¯·è®¿é—® http://localhost:{settings.NGINX_PORT}/")
    yield
    await provider.close()
    logger.info("åº”ç”¨å…³é—­ã€‚")

app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description=settings.DESCRIPTION,
    lifespan=lifespan
)

# --- æŒ‚è½½é™æ€æ–‡ä»¶ç›®å½• ---
app.mount("/static", StaticFiles(directory="static"), name="static")

# --- å®‰å…¨ä¾èµ– ---
async def verify_api_key(authorization: Optional[str] = Header(None)):
    if settings.API_MASTER_KEY and settings.API_MASTER_KEY != "1":
        if not authorization or "bearer" not in authorization.lower():
            raise HTTPException(status_code=401, detail="éœ€è¦ Bearer Token è®¤è¯ã€‚")
        token = authorization.split(" ")[-1]
        if token != settings.API_MASTER_KEY:
            raise HTTPException(status_code=403, detail="æ— æ•ˆçš„ API Keyã€‚")

# --- API è·¯ç”± ---
@app.post("/v1/chat/completions", dependencies=[Depends(verify_api_key)])
async def chat_completions(request: Request):
    """
    å…¼å®¹ Cherry Studio ç­‰å®¢æˆ·ç«¯çš„èŠå¤©æ¥å£ã€‚
    å®ƒä¼šä»æ¶ˆæ¯ä¸­æå–å›¾ç‰‡ URL æˆ– Base64 Data URIï¼Œç„¶åè°ƒç”¨æ ¸å¿ƒæœåŠ¡ã€‚
    åŒæ—¶ï¼Œå®ƒä¼šä»è¯·æ±‚ä½“ä¸­æå– 'language' å’Œ 'structured_prompt' å‚æ•°ã€‚
    """
    try:
        request_data = await request.json()
        messages = request_data.get("messages", [])
        if not messages:
            raise HTTPException(status_code=400, detail="è¯·æ±‚ä½“ä¸­ç¼ºå°‘ 'messages' å­—æ®µã€‚")

        # æå–è¯­è¨€å’Œç»“æ„åŒ–æç¤ºå‚æ•°ï¼Œå¦‚æœæœªæä¾›åˆ™ä½¿ç”¨é»˜è®¤å€¼
        language = request_data.get("language", "en")
        structured_prompt = request_data.get("structured_prompt", "yes")

        # æŸ¥æ‰¾æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ä¸­çš„å›¾ç‰‡ä¿¡æ¯
        image_data_uri = None
        url_pattern = re.compile(r'https?://[^\s\)]+')
        data_uri_pattern = re.compile(r'data:image/[a-zA-Z]+;base64,[a-zA-Z0-9+/=]+')

        for msg in reversed(messages):
            if msg.get("role") == "user":
                content = msg.get("content", "")
                if isinstance(content, str):
                    # å°è¯•åŒ¹é… Data URI
                    data_uri_match = data_uri_pattern.search(content)
                    if data_uri_match:
                        image_data_uri = data_uri_match.group(0)
                        logger.info("ä»æ¶ˆæ¯å†…å®¹ä¸­æå–åˆ° Base64 Data URIã€‚")
                        break
                    
                    # å°è¯•åŒ¹é… URL
                    url_match = url_pattern.search(content)
                    if url_match:
                        image_url = url_match.group(0)
                        logger.info(f"ä»æ¶ˆæ¯å†…å®¹ä¸­æå–åˆ°å›¾ç‰‡ URL: {image_url}")
                        image_data_uri = await provider.url_to_data_uri(image_url)
                        break
        
        if not image_data_uri:
            raise HTTPException(status_code=400, detail="åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡ URL æˆ– Base64 Data URIã€‚")

        return await provider.get_prompt_as_chat_completion(image_data_uri, language, structured_prompt)

    except Exception as e:
        logger.error(f"å¤„ç†èŠå¤©è¯·æ±‚æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")

@app.post("/api/generate-from-upload", dependencies=[Depends(verify_api_key)])
async def generate_from_upload(
    image: UploadFile = File(...),
    language: str = Form("en"),
    structured_prompt: str = Form("yes")
):
    """
    ä¸“ä¸º Web UI è®¾è®¡çš„æ¥å£ï¼Œå¤„ç†æ–‡ä»¶ä¸Šä¼ ã€‚
    """
    try:
        image_bytes = await image.read()
        import base64
        mime_type = image.content_type
        base64_data = base64.b64encode(image_bytes).decode('utf-8')
        data_uri = f"data:{mime_type};base64,{base64_data}"
        
        prompt = await provider.get_prompt_internal(data_uri, language, structured_prompt)
        return JSONResponse(content={"prompt": prompt})
    except Exception as e:
        logger.error(f"å¤„ç†æ–‡ä»¶ä¸Šä¼ æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")


@app.get("/v1/models", dependencies=[Depends(verify_api_key)], response_class=JSONResponse)
async def list_models():
    return await provider.get_models()

# --- Web UI è·¯ç”± ---
@app.get("/", response_class=HTMLResponse, include_in_schema=False)
async def serve_ui():
    try:
        with open("static/index.html", "r", encoding="utf-8") as f:
            return HTMLResponse(content=f.read())
    except FileNotFoundError:
        raise HTTPException(status_code=404, detail="UI æ–‡ä»¶ (static/index.html) æœªæ‰¾åˆ°ã€‚")


--- æ–‡ä»¶è·¯å¾„: nginx.conf ---

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream imagetoprompt_backend {
        server app:8000;
    }

    server {
        listen 80;
        server_name localhost;

        client_max_body_size 2M; # å…è®¸ä¸Šä¼ æ›´å¤§çš„å›¾ç‰‡æ–‡ä»¶

        location / {
            proxy_pass http://imagetoprompt_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
        }
    }
}


--- æ–‡ä»¶è·¯å¾„: requirements.txt ---

fastapi
uvicorn[standard]
pydantic-settings
python-dotenv
httpx
aiohttp
python-multipart
loguru


--- æ–‡ä»¶è·¯å¾„: app\core\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\core\config.py ---

from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import Optional, List, Dict

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding='utf-8',
        extra="ignore"
    )

    APP_NAME: str = "imagetoprompt-2api"
    APP_VERSION: str = "1.1.0" # ç‰ˆæœ¬å‡çº§
    DESCRIPTION: str = "ä¸€ä¸ªå°† imagetoprompt.app è½¬æ¢ä¸ºå…¼å®¹ OpenAI æ ¼å¼ API çš„é«˜æ€§èƒ½ä»£ç†ï¼Œæ”¯æŒå¤šè¯­è¨€å’Œç»“æ„åŒ–æç¤ºã€‚"

    API_MASTER_KEY: Optional[str] = None
    NGINX_PORT: int = 8088

    API_REQUEST_TIMEOUT: int = 180

    DEFAULT_MODEL: str = "image-to-prompt-v1"
    KNOWN_MODELS: List[str] = ["image-to-prompt-v1"]

    # æ–°å¢ï¼šæ”¯æŒçš„è¯­è¨€åˆ—è¡¨ï¼Œé”®ä¸ºæ˜¾ç¤ºåç§°ï¼Œå€¼ä¸º API å‚æ•°
    SUPPORTED_LANGUAGES: Dict[str, str] = {
        "English": "en",
        "EspaÃ±ol": "es",
        "Deutsch": "de",
        "FranÃ§ais": "fr",
        "PortuguÃªs": "pt",
        "ç®€ä½“ä¸­æ–‡": "zh-CN",
        "ç¹é«”ä¸­æ–‡": "zh-TW",
        "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©": "ar",
        "Ğ ÑƒÑÑĞºĞ¸Ğ¹": "ru",
        "æ—¥æœ¬èª": "ja",
        "í•œêµ­ì–´": "ko"
    }

settings = Settings()


--- æ–‡ä»¶è·¯å¾„: app\providers\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\providers\base_provider.py ---

from abc import ABC, abstractmethod
from typing import Dict, Any
from fastapi.responses import JSONResponse

class BaseProvider(ABC):
    @abstractmethod
    async def get_prompt_from_data_uri(self, data_uri: str) -> JSONResponse:
        pass

    @abstractmethod
    async def get_models(self) -> JSONResponse:
        pass


--- æ–‡ä»¶è·¯å¾„: app\providers\imagetoprompt_provider.py ---

import time
import uuid
import mimetypes
from typing import Dict, Any

import httpx
import aiohttp
from fastapi import HTTPException
from fastapi.responses import JSONResponse
from loguru import logger

from app.core.config import settings

class ImageToPromptProvider:
    UPSTREAM_URL = "https://www.imagetoprompt.app/api/generate-prompt"

    def __init__(self):
        self.client: httpx.AsyncClient = None
        self.session: aiohttp.ClientSession = None

    async def initialize(self):
        self.client = httpx.AsyncClient(timeout=settings.API_REQUEST_TIMEOUT)
        self.session = aiohttp.ClientSession()

    async def close(self):
        if self.client:
            await self.client.aclose()
        if self.session:
            await self.session.close()

    async def url_to_data_uri(self, url: str) -> str:
        """ä» URL ä¸‹è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸º Base64 Data URI"""
        try:
            async with self.session.get(url) as response:
                response.raise_for_status()
                image_bytes = await response.read()
                mime_type = response.content_type or mimetypes.guess_type(url)[0] or "image/png"
                
                import base64
                base64_data = base64.b64encode(image_bytes).decode('utf-8')
                return f"data:{mime_type};base64,{base64_data}"
        except Exception as e:
            logger.error(f"ä¸‹è½½æˆ–è½¬æ¢å›¾ç‰‡å¤±è´¥: {url}, é”™è¯¯: {e}")
            raise HTTPException(status_code=400, detail=f"æ— æ³•ä» URL ä¸‹è½½æˆ–å¤„ç†å›¾ç‰‡: {e}")

    async def get_prompt_internal(self, data_uri: str, language: str, structured_prompt: str) -> str:
        """
        æ ¸å¿ƒå†…éƒ¨å‡½æ•°ï¼Œä» Data URI è·å–æç¤ºè¯ã€‚
        :param data_uri: å›¾ç‰‡çš„ Base64 Data URIã€‚
        :param language: ç›®æ ‡è¯­è¨€ä»£ç  (ä¾‹å¦‚ 'en', 'zh-CN')ã€‚
        :param structured_prompt: æ˜¯å¦ä½¿ç”¨ç»“æ„åŒ–æç¤º ('yes' æˆ– 'no')ã€‚
        :return: ç”Ÿæˆçš„æç¤ºè¯å­—ç¬¦ä¸²ã€‚
        """
        headers = self._prepare_headers()
        payload = {
            "imageBase64": data_uri,
            "language": language,
            "structuredPrompt": structured_prompt
        }

        try:
            logger.info(f"æ­£åœ¨å‘ä¸Šæ¸¸ API å‘é€è¯·æ±‚... è¯­è¨€: {language}, ç»“æ„åŒ–: {structured_prompt}")
            response = await self.client.post(self.UPSTREAM_URL, headers=headers, json=payload)
            response.raise_for_status()
            
            data = response.json()
            if not data.get("success") or "prompt" not in data:
                error_detail = data.get('prompt', 'æœªçŸ¥é”™è¯¯')
                logger.error(f"ä¸Šæ¸¸ API è¿”å›å¤±è´¥: {error_detail}")
                raise HTTPException(status_code=502, detail=f"ä¸Šæ¸¸ API è¿”å›å¤±è´¥: {error_detail}")

            prompt = data["prompt"]
            logger.success(f"æˆåŠŸè·å–æç¤ºè¯: {prompt[:100]}...")
            return prompt

        except httpx.HTTPStatusError as e:
            logger.error(f"è¯·æ±‚ä¸Šæ¸¸ API å¤±è´¥ï¼ŒçŠ¶æ€ç : {e.response.status_code}, å“åº”: {e.response.text}")
            raise HTTPException(status_code=502, detail=f"ä¸Šæ¸¸æœåŠ¡é”™è¯¯: {e.response.text}")
        except Exception as e:
            logger.error(f"å¤„ç†è¯·æ±‚æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}", exc_info=True)
            raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")

    async def get_prompt_as_chat_completion(self, data_uri: str, language: str, structured_prompt: str) -> JSONResponse:
        """ä¸ºèŠå¤©ç«¯ç‚¹è°ƒç”¨æ ¸å¿ƒå‡½æ•°å¹¶æ ¼å¼åŒ–ä¸º OpenAI å“åº”ã€‚"""
        prompt = await self.get_prompt_internal(data_uri, language, structured_prompt)
        
        chat_response = {
            "id": f"chatcmpl-{uuid.uuid4()}",
            "object": "chat.completion",
            "created": int(time.time()),
            "model": settings.DEFAULT_MODEL,
            "choices": [{
                "index": 0,
                "message": {
                    "role": "assistant",
                    "content": prompt,
                },
                "finish_reason": "stop",
            }],
            "usage": {
                "prompt_tokens": 0,
                "completion_tokens": 0,
                "total_tokens": 0,
            }
        }
        return JSONResponse(content=chat_response)

    def _prepare_headers(self) -> Dict[str, str]:
        return {
            "Accept": "*/*",
            "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
            "Content-Type": "application/json",
            "Origin": "https://www.imagetoprompt.app",
            "Referer": "https://www.imagetoprompt.app/",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",
        }

    async def get_models(self) -> JSONResponse:
        model_data = {
            "object": "list",
            "data": [
                {"id": name, "object": "model", "created": int(time.time()), "owned_by": "lzA6"}
                for name in settings.KNOWN_MODELS
            ]
        }
        return JSONResponse(content=model_data)


--- æ–‡ä»¶è·¯å¾„: app\utils\sse_utils.py ---

import json
import time
from typing import Dict, Any, Optional

DONE_CHUNK = b"data: [DONE]\n\n"

def create_sse_data(data: Dict[str, Any]) -> bytes:
    """å°†å­—å…¸æ•°æ®æ ¼å¼åŒ–ä¸º SSE äº‹ä»¶å­—ç¬¦ä¸²ã€‚"""
    return f"data: {json.dumps(data, ensure_ascii=False)}\n\n".encode('utf-8')

def create_chat_completion_chunk(
    request_id: str,
    model: str,
    content: str,
    finish_reason: Optional[str] = None
) -> Dict[str, Any]:
    """åˆ›å»ºä¸€ä¸ªä¸ OpenAI å…¼å®¹çš„èŠå¤©è¡¥å…¨æµå¼å—ã€‚"""
    return {
        "id": request_id,
        "object": "chat.completion.chunk",
        "created": int(time.time()),
        "model": model,
        "choices": [
            {
                "index": 0,
                "delta": {"content": content},
                "finish_reason": finish_reason
            }
        ]
    }


--- æ–‡ä»¶è·¯å¾„: static\index.html ---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageToPrompt-2API æµ‹è¯•é¢æ¿ v1.1</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h1>ImageToPrompt-2API</h1>
            <p>ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼ŒAI å°†ä¸ºå…¶ç”Ÿæˆè¯¦ç»†çš„æè¿°æ€§æç¤ºè¯ã€‚</p>
            
            <div class="form-group">
                <label for="api-key">API Key</label>
                <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key" value="1">
            </div>

            <div id="image-uploader" class="image-drop-zone">
                <img id="image-preview" src="#" alt="å›¾ç‰‡é¢„è§ˆ" class="hidden">
                <span id="upload-placeholder">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</span>
            </div>
            <input type="file" id="image-upload-input" accept="image/*" class="hidden">

            <div class="form-group">
                <label for="language-select">æç¤ºè¯è¯­è¨€ (Prompt Language)</label>
                <select id="language-select"></select>
            </div>

            <div class="form-group">
                <label for="structured-prompt-select">ç»“æ„åŒ–æç¤º (Structured Prompt)</label>
                <select id="structured-prompt-select">
                    <option value="yes" selected>æ˜¯ (Yes)</option>
                    <option value="no">å¦ (No)</option>
                </select>
            </div>

            <button id="generate-btn">
                <span id="btn-text">ç”Ÿæˆæç¤ºè¯</span>
                <div id="btn-spinner" class="spinner-sm hidden"></div>
            </button>
        </div>
        <div class="right-panel">
            <div id="result-placeholder" class="placeholder">
                <p>ç”Ÿæˆçš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
            </div>
            <div id="result-container" class="hidden">
                <h3>ç”Ÿæˆçš„æç¤ºè¯:</h3>
                <div id="prompt-output" class="prompt-box"></div>
                <button id="copy-btn">å¤åˆ¶</button>
            </div>
            <div id="error-message" class="error hidden"></div>
        </div>
    </div>
    <script src="/static/script.js"></script>
</body>
</html>

--- æ–‡ä»¶è·¯å¾„: static\script.js ---

document.addEventListener('DOMContentLoaded', () => {
    const apiKeyInput = document.getElementById('api-key');
    const imageUploader = document.getElementById('image-uploader');
    const imageUploadInput = document.getElementById('image-upload-input');
    const imagePreview = document.getElementById('image-preview');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const generateBtn = document.getElementById('generate-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const resultPlaceholder = document.getElementById('result-placeholder');
    const resultContainer = document.getElementById('result-container');
    const promptOutput = document.getElementById('prompt-output');
    const copyBtn = document.getElementById('copy-btn');
    const errorMessage = document.getElementById('error-message');
    const languageSelect = document.getElementById('language-select');
    const structuredPromptSelect = document.getElementById('structured-prompt-select');

    let selectedFile = null;

    // --- è¯­è¨€é€‰é¡¹ ---
    const supportedLanguages = {
        "English": "en", "EspaÃ±ol": "es", "Deutsch": "de", "FranÃ§ais": "fr",
        "PortuguÃªs": "pt", "ç®€ä½“ä¸­æ–‡": "zh-CN", "ç¹é«”ä¸­æ–‡": "zh-TW", "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©": "ar",
        "Ğ ÑƒÑÑĞºĞ¸Ğ¹": "ru", "æ—¥æœ¬èª": "ja", "í•œêµ­ì–´": "ko"
    };

    // --- åˆå§‹åŒ– ---
    function initialize() {
        // å¡«å……è¯­è¨€ä¸‹æ‹‰æ¡†
        for (const [name, code] of Object.entries(supportedLanguages)) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            if (code === 'en') {
                option.selected = true;
            }
            languageSelect.appendChild(option);
        }
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    imageUploader.addEventListener('click', () => imageUploadInput.click());
    imageUploader.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploader.classList.add('dragover');
    });
    imageUploader.addEventListener('dragleave', () => imageUploader.classList.remove('dragover'));
    imageUploader.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploader.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        handleFile(file);
    });
    imageUploadInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    generateBtn.addEventListener('click', handleGenerate);
    copyBtn.addEventListener('click', copyToClipboard);

    // --- æ ¸å¿ƒå‡½æ•° ---
    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) {
            showError("è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ã€‚");
            return;
        }
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove('hidden');
            uploadPlaceholder.classList.add('hidden');
            hideError();
        };
        reader.readAsDataURL(file);
    }

    async function handleGenerate() {
        const apiKey = apiKeyInput.value.trim();
        if (!selectedFile) {
            showError("è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡ã€‚");
            return;
        }
        if (!apiKey) {
            showError("è¯·è¾“å…¥ API Keyã€‚");
            return;
        }

        setLoading(true);

        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('language', languageSelect.value);
        formData.append('structured_prompt', structuredPromptSelect.value);

        try {
            const response = await fetch('/api/generate-from-upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                },
                body: formData
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'ç”Ÿæˆå¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯ã€‚');
            }

            displayResult(result.prompt);

        } catch (error) {
            showError(error.message);
        } finally {
            setLoading(false);
        }
    }

    function displayResult(prompt) {
        resultPlaceholder.classList.add('hidden');
        resultContainer.classList.remove('hidden');
        promptOutput.textContent = prompt;
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(promptOutput.textContent).then(() => {
            copyBtn.textContent = 'å·²å¤åˆ¶!';
            setTimeout(() => { copyBtn.textContent = 'å¤åˆ¶'; }, 2000);
        }).catch(err => {
            showError('å¤åˆ¶å¤±è´¥: ' + err);
        });
    }

    // --- UI çŠ¶æ€è¾…åŠ©å‡½æ•° ---
    function setLoading(isLoading) {
        generateBtn.disabled = isLoading;
        btnText.style.display = isLoading ? 'none' : 'inline';
        btnSpinner.classList.toggle('hidden', !isLoading);
        if (isLoading) {
            hideError();
            resultContainer.classList.add('hidden');
            resultPlaceholder.classList.remove('hidden');
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function hideError() {
        errorMessage.classList.add('hidden');
    }

    // --- é¡µé¢åŠ è½½åæ‰§è¡Œ ---
    initialize();
});


--- æ–‡ä»¶è·¯å¾„: static\style.css ---

:root {
    --bg-color: #f7f8fa;
    --panel-bg: #ffffff;
    --border-color: #e5e7eb;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --input-bg: #f9fafb;
    --error-bg: #fee2e2;
    --error-text: #b91c1c;
    --error-border: #fca5a5;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    background-color: var(--bg-color);
    color: var(--text-primary);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    padding: 20px;
}

.container {
    display: flex;
    width: 100%;
    max-width: 1000px;
    height: 80vh;
    min-height: 550px;
    background-color: var(--panel-bg);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.left-panel, .right-panel {
    padding: 32px;
    display: flex;
    flex-direction: column;
}

.left-panel {
    width: 45%;
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
}

.right-panel {
    width: 55%;
    justify-content: center;
    align-items: center;
}

h1 { margin: 0 0 8px 0; }
.left-panel p { margin: 0 0 24px 0; color: var(--text-secondary); }

.form-group { margin-bottom: 16px; }
label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
input[type="password"], select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--input-bg);
    font-size: 14px;
}

.image-drop-zone {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    background-color: var(--input-bg);
    transition: border-color 0.2s;
    margin-bottom: 16px;
}
.image-drop-zone.dragover { border-color: var(--primary-color); }
#image-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
#upload-placeholder { color: var(--text-secondary); }

#generate-btn {
    width: 100%;
    padding: 12px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: auto;
}
#generate-btn:hover { background-color: var(--primary-hover); }
#generate-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }

.spinner-sm {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.placeholder { text-align: center; color: var(--text-secondary); }
.hidden { display: none; }

#result-container { width: 100%; }
.prompt-box {
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 16px;
    min-height: 100px;
    max-height: 40vh;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 8px 0 16px 0;
    line-height: 1.6;
}
#copy-btn {
    padding: 8px 16px;
    background-color: #e5e7eb;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
}
#copy-btn:hover { background-color: #d1d5db; }

.error {
    color: var(--error-text);
    background-color: var(--error-bg);
    border: 1px solid var(--error-border);
    padding: 12px;
    border-radius: 6px;
    text-align: center;
    margin-top: 16px;
}



